- name: Install Fail2Ban
  ansible.builtin.apt:
    name: fail2ban
    state: present
  tags: fail2ban
  become: true

- name: Ensure Fail2Ban service is running
  ansible.builtin.service:
    name: fail2ban
    state: started
    enabled: true
  register: result
  ignore_errors: true
  tags: fail2ban
  become: true
  changed_when: false # noqa no-changed-when

- name: Display fail2ban logs from journalctl if service doesn't start
  ansible.builtin.command: journalctl -u fail2ban.service -n 50 --no-pager
  register: logs
  tags: fail2ban
  become: true
  changed_when: "result is failed"

- name: Display fail2ban logs from stdout_lines if service doesn't start
  ansible.builtin.debug:
    var: logs.stdout_lines
  when: "result is failed"
  changed_when: false # noqa no-changed-when
  tags: fail2ban

- name: Deploy custom jail configurations
  ansible.builtin.copy:
    src: files/fail2ban/jail.local
    dest: /etc/fail2ban/jail.local
    mode: '0644'
    owner: root
    group: root
  notify: Restart fail2ban
  tags: fail2ban
  become: true
